user nobody;
worker_processes 4;

events {
    worker_connections  1024;
}

http {

  ## MIME Types
  include       mime.types;
  default_type  application/octet-stream;

  ## Logging
  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

  ## Size Limits
  client_body_buffer_size   128K;
  client_header_buffer_size 128K;
  client_max_body_size       10g;
  large_client_header_buffers 1 2k;

  ## Timeouts
  client_body_timeout   60;
  client_header_timeout 60;
  keepalive_timeout     60 60;
  send_timeout          60;

  #TCP Options
  tcp_nopush     on;
  tcp_nodelay    on;

  ## General Options
  ignore_invalid_headers   on;
  keepalive_requests       50;
  recursive_error_pages    on;
  server_tokens           off;
  server_name_in_redirect off;

  ## Compression
  # Disable gzip to avoid the removal of the ETag header
  gzip              off;

  upstream php-fpm {
      server 127.0.0.1:9000;
  }

  server {
      listen 80;

      root  /opt/owncloud;
      index index.php;

      server_name _;

      fastcgi_buffers 64 4K;
      client_max_body_size 10g;

      # Uncomment if your server is build with the ngx_pagespeed module
      # This module is currently not supported.
      #pagespeed off;

      rewrite ^/caldav(.*)$  /remote.php/caldav$1 redirect;
      rewrite ^/carddav(.*)$ /remote.php/carddav$1 redirect;
      rewrite ^/webdav(.*)$  /remote.php/webdav$1 redirect;

      error_page 403 /core/templates/403.php;
      error_page 404 /core/templates/404.php;

      location = /robots.txt {
          allow all;
          log_not_found off;
          access_log off;
      }

      location ~ ^/(?:\.htaccess|data|config|db_structure\.xml|README){
          deny all;
      }

      location / {
          # The following 2 rules are only needed with webfinger
          rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
          rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json last;

          rewrite ^/.well-known/carddav /remote.php/carddav/ redirect;
          rewrite ^/.well-known/caldav /remote.php/caldav/ redirect;

          rewrite ^(/core/doc/[^\/]+/)$ $1/index.html;

          try_files $uri $uri/ /index.php;
      }

      location ~ \.php(?:$|/) {
          fastcgi_split_path_info ^(.+\.php)(/.+)$;
          include fastcgi_params;
          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
          fastcgi_param PATH_INFO $fastcgi_path_info;
          #fastcgi_param HTTPS on;
          fastcgi_pass php-fpm;
      }
  }
}
